<!DOCTYPE html>
<html lang="da">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Thomas' Flashkort</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@400;500;600;700;800&display=swap" rel="stylesheet">
    
    <!-- Ikoner -->
    <link rel="icon" type="image/png" sizes="32x32" href="/favicon.png">
    <link rel="icon" href="/favicon.svg" type="image/svg+xml">

    <style>
        /* --- MODERNE CSS STYLES --- */
        
        :root {
            --primary: #6366f1;
            --primary-dark: #4f46e5;
            --secondary: #ec4899;
            --bg-gradient: linear-gradient(135deg, #f5f7fa 0%, #c3cfe2 100%);
        }

        body {
            font-family: 'Plus Jakarta Sans', sans-serif; /* Mere moderne font end Inter */
            -webkit-font-smoothing: antialiased;
            /* Animeret baggrund */
            background: linear-gradient(-45deg, #e0e7ff, #f3e8ff, #eef2ff, #fff1f2);
            background-size: 400% 400%;
            animation: gradientBG 15s ease infinite;
            color: #1e293b;
        }

        @keyframes gradientBG {
            0% { background-position: 0% 50%; }
            50% { background-position: 100% 50%; }
            100% { background-position: 0% 50%; }
        }

        /* Overskrift Gradient */
        .gradient-text {
            background: linear-gradient(to right, #4f46e5, #9333ea);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
        }

        /* Glassmorphism Panel */
        .glass-panel {
            background: rgba(255, 255, 255, 0.7);
            backdrop-filter: blur(12px);
            -webkit-backdrop-filter: blur(12px);
            border: 1px solid rgba(255, 255, 255, 0.5);
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.05), 0 10px 15px -3px rgba(0, 0, 0, 0.05);
        }

        /* Navigationsknapper - Pill shape */
        .nav-btn {
            padding: 0.75rem 1.5rem;
            border-radius: 9999px; /* Fuld runding */
            font-weight: 700;
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            width: 100%;
            max-width: 200px;
            border: none;
            cursor: pointer;
            letter-spacing: 0.025em;
            position: relative;
            overflow: hidden;
        }
        .nav-btn.active {
            background: linear-gradient(135deg, #6366f1 0%, #4f46e5 100%);
            color: white;
            box-shadow: 0 10px 15px -3px rgba(99, 102, 241, 0.4);
            transform: translateY(-1px);
        }
        .nav-btn:not(.active) {
            background-color: white;
            color: #64748b;
            box-shadow: 0 2px 4px rgba(0,0,0,0.05);
        }
        .nav-btn:not(.active):hover {
            background-color: #f8fafc;
            color: #334155;
            transform: translateY(-1px);
        }

        /* Action knapper (Start, etc) */
        .action-btn {
            display: inline-flex;
            align-items: center;
            justify-content: center;
            padding: 0.875rem 2rem;
            border-radius: 1rem;
            font-weight: 700;
            transition: all 0.2s cubic-bezier(0.4, 0, 0.2, 1);
            border: none;
            cursor: pointer;
            text-transform: uppercase;
            font-size: 0.875rem;
            letter-spacing: 0.05em;
        }
        .action-btn:hover { transform: translateY(-2px); box-shadow: 0 10px 15px -3px rgba(0,0,0,0.1); }
        .action-btn:active { transform: translateY(0); }
        .action-btn:disabled { opacity: 0.6; cursor: not-allowed; transform: none; box-shadow: none; }

        /* Feedback knapper */
        .feedback-btn {
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 1rem;
            border-radius: 1rem;
            font-weight: 700;
            cursor: pointer;
            transition: all 0.2s;
            border: none; /* Fjernet border for renere look */
            width: 100%;
            font-size: 0.95rem;
            position: relative; 
            z-index: 5;
            box-shadow: 0 4px 6px rgba(0,0,0,0.05);
            /* Soft colors override */
        }
        .feedback-btn:hover { transform: translateY(-2px); box-shadow: 0 8px 12px rgba(0,0,0,0.1); }
        .feedback-btn:active { transform: scale(0.96); }

        /* Specifik feedback styling */
        #feedback-correct-btn { background: #dcfce7; color: #15803d; }
        #feedback-correct-btn:hover { background: #bbf7d0; }
        
        #feedback-unsure-btn { background: #fef9c3; color: #a16207; }
        #feedback-unsure-btn:hover { background: #fde047; }
        
        #feedback-incorrect-btn { background: #fee2e2; color: #b91c1c; }
        #feedback-incorrect-btn:hover { background: #fecaca; }

        /* --- FLASHCARD 3D --- */
        .perspective-container {
            perspective: 1200px; /* Lidt dybere perspektiv */
            width: 100%;
            max-width: 42rem; 
            margin: 0 auto;
            position: relative;
            height: 420px !important; /* Lidt h√∏jere for luft */
            min-height: 420px;
            z-index: 10;
            display: block; 
        }

        .card {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            cursor: pointer;
            transform-style: preserve-3d;
            transition: transform 0.7s cubic-bezier(0.175, 0.885, 0.32, 1.275); /* Bouncy flip effect */
            transform-origin: center center;
        }

        .card.is-flipped {
            transform: rotateY(180deg);
        }

        .card-face {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            -webkit-backface-visibility: hidden;
            backface-visibility: hidden;
            border-radius: 1.5rem;
            display: flex;
            flex-direction: column;
            overflow: hidden;
            /* Moderne skygge */
            box-shadow: 0 20px 25px -5px rgba(0, 0, 0, 0.1), 0 8px 10px -6px rgba(0, 0, 0, 0.1);
        }

        .card-front {
            background-color: white;
            z-index: 2;
            transform: rotateY(0deg);
            border: 1px solid rgba(0,0,0,0.05);
        }

        .card-back {
            /* L√¶kker gradient baggrund */
            background: linear-gradient(135deg, #4f46e5 0%, #7c3aed 100%);
            color: white;
            transform: rotateY(180deg);
            z-index: 1;
        }

        .card-content-scroll {
            flex-grow: 1;
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 2.5rem 3rem;
            overflow-y: auto;
            width: 100%;
        }

        /* Custom scrollbar til kortet */
        .card-content-scroll::-webkit-scrollbar { width: 6px; }
        .card-content-scroll::-webkit-scrollbar-track { background: transparent; }
        .card-content-scroll::-webkit-scrollbar-thumb { background: rgba(0,0,0,0.1); border-radius: 10px; }
        .card-back .card-content-scroll::-webkit-scrollbar-thumb { background: rgba(255,255,255,0.2); }

        .card-text {
            text-align: center;
            font-size: 1.4rem;
            font-weight: 500;
            line-height: 1.5;
            white-space: pre-wrap;
            word-break: break-word;
        }

        @media (max-width: 640px) {
            .perspective-container {
                height: 360px !important;
                min-height: 360px;
            }
            .card-text {
                font-size: 1.15rem;
                padding: 0 0.5rem;
            }
        }

        .card-footer {
            height: 4rem;
            display: flex;
            align-items: center;
            justify-content: center;
            flex-shrink: 0;
            padding: 0 1rem;
            font-weight: 700;
            letter-spacing: 0.05em;
        }

        .star-btn {
            position: absolute;
            top: 1.25rem;
            right: 1.25rem;
            z-index: 20;
            background: transparent;
            border: none;
            cursor: pointer;
            transition: transform 0.2s;
        }
        .star-btn:hover { transform: scale(1.2); }
        .star-btn.active .star-icon {
            color: #fbbf24 !important;
            fill: #fbbf24 !important;
            filter: drop-shadow(0 0 8px rgba(251, 191, 36, 0.5));
        }
        
        /* Select styling */
        .custom-select {
            appearance: none;
            background-image: url("data:image/svg+xml,%3csvg xmlns='http://www.w3.org/2000/svg' fill='none' viewBox='0 0 20 20'%3e%3cpath stroke='%236b7280' stroke-linecap='round' stroke-linejoin='round' stroke-width='1.5' d='M6 8l4 4 4-4'/%3e%3c/svg%3e");
            background-position: right 1rem center;
            background-repeat: no-repeat;
            background-size: 1.5em 1.5em;
        }

        /* Quiz Styles */
        .mode-btn {
            padding: 0.6rem 1.5rem;
            border-radius: 0.75rem;
            font-size: 0.9rem;
            font-weight: 600;
            cursor: pointer;
            border: 2px solid transparent;
            background: rgba(255,255,255,0.5);
            color: #64748b;
            transition: all 0.2s;
        }
        .mode-btn:hover { background: white; }
        .mode-btn.active {
            background: #eff6ff;
            color: #4f46e5;
            border-color: #4f46e5;
        }
        
        .question-option {
            display: flex;
            align-items: center;
            padding: 1.2rem;
            border: 2px solid transparent; /* Usynlig border default */
            border-radius: 1rem;
            background-color: white;
            width: 100%;
            cursor: pointer;
            transition: all 0.2s;
            box-shadow: 0 2px 4px rgba(0,0,0,0.03);
            font-weight: 500;
        }
        .question-option:hover { 
            transform: translateY(-2px); 
            box-shadow: 0 10px 15px -3px rgba(0,0,0,0.05);
            border-color: #e2e8f0;
        }
        .question-option.selected {
            border-color: #6366f1;
            background-color: #eef2ff;
            color: #4338ca;
            font-weight: 600;
        }
        
        .correct-answer { background-color: #dcfce7 !important; border-color: #22c55e !important; color: #14532d !important; }
        .incorrect-answer { background-color: #fee2e2 !important; border-color: #ef4444 !important; color: #7f1d1d !important; }
        
        .explanation {
            margin-top: 1.5rem; padding: 1.5rem; border-radius: 1rem; border: 1px solid;
            line-height: 1.6;
        }
        .explanation.correct { background-color: #f0fdf4; border-color: #bbf7d0; color: #166534; }
        .explanation.incorrect { background-color: #fef2f2; border-color: #fecaca; color: #991b1b; }
    </style>
</head>
<body class="flex flex-col items-center justify-start min-h-screen p-4 sm:p-6">

    <div class="w-full max-w-3xl mx-auto mb-8 mt-6">
        <h1 class="text-4xl sm:text-6xl font-extrabold text-center mb-2 tracking-tight gradient-text pb-2">Thomas' Flashkort</h1>
        <p class="text-center text-slate-500 font-medium mb-8">Master din psykologi viden</p>
        
        <div class="flex flex-col sm:flex-row justify-center gap-4 mb-8 bg-white/50 p-2 rounded-full backdrop-blur-sm max-w-fit mx-auto shadow-sm">
            <button id="show-flashcards-btn" class="nav-btn active">Flashcards</button>
            <button id="show-quiz-btn" class="nav-btn">Quiz Mode</button>
        </div>
    </div>

    <!-- FLASHCARD SEKTION -->
    <div id="flashcard-section" class="w-full max-w-3xl mx-auto block animate-fade-in">
        
        <!-- Controls Panel -->
        <div class="glass-panel rounded-3xl p-6 sm:p-8 mb-8 text-center">
            <label for="category-select" class="block text-slate-500 text-xs font-bold uppercase tracking-widest mb-3">V√¶lg Kategori</label>
            <div class="relative max-w-md mx-auto mb-8">
                <select id="category-select" class="custom-select block w-full rounded-2xl border-0 bg-slate-100 py-4 pl-6 pr-10 text-slate-800 font-semibold focus:ring-2 focus:ring-indigo-500 cursor-pointer shadow-inner hover:bg-slate-200 transition-colors"></select>
            </div>
            
            <div class="flex flex-col sm:flex-row items-center justify-center gap-4">
                <button id="reset-deck-btn" class="action-btn bg-indigo-600 hover:bg-indigo-700 text-white shadow-lg shadow-indigo-200 w-full sm:w-auto">
                    <span class="mr-2">‚Ü∫</span> Start forfra
                </button>
                <div class="flex items-center space-x-3 bg-white px-5 py-3.5 rounded-2xl border border-slate-200 cursor-pointer shadow-sm hover:border-indigo-300 transition-colors w-full sm:w-auto justify-center" onclick="document.getElementById('show-back-first-toggle').click()">
                    <input type="checkbox" id="show-back-first-toggle" class="h-5 w-5 text-indigo-600 rounded border-gray-300 focus:ring-indigo-500 cursor-pointer">
                    <label for="show-back-first-toggle" class="text-slate-600 font-bold text-sm select-none cursor-pointer">Vis bagside f√∏rst</label>
                </div>
            </div>
        </div>

        <!-- Progress Bar -->
        <div class="flex items-center justify-between text-xs font-bold text-slate-400 uppercase tracking-wider mb-2 px-2">
            <span>Fremskridt</span>
            <span id="progress-text">0 kort tilbage</span>
        </div>
        <div class="w-full bg-slate-200/70 rounded-full h-4 mb-8 overflow-hidden relative shadow-inner">
            <div id="progress-bar-fill" class="bg-gradient-to-r from-indigo-500 to-purple-500 h-4 rounded-full transition-all duration-700 ease-out shadow-[0_0_10px_rgba(99,102,241,0.5)]" style="width: 0%"></div>
        </div>

        <!-- KORT CONTAINER -->
        <div id="card-container-wrapper" class="perspective-container mb-10">
            <div id="flashcard" class="card">
                
                <!-- Forside -->
                <div class="card-face card-front">
                    <button class="star-btn" title="Gem til senere">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-8 w-8 star-icon text-slate-200 transition-colors" viewBox="0 0 20 20" fill="currentColor">
                            <path d="M9.049 2.927c.3-.921 1.603-.921 1.902 0l1.07 3.292a1 1 0 00.95.69h3.462c.969 0 1.371 1.24.588 1.81l-2.8 2.034a1 1 0 00-.364 1.118l1.07 3.292c.3.921-.755 1.688-1.54 1.118l-2.8-2.034a1 1 0 00-1.175 0l-2.8 2.034c-.784.57-1.838-.197-1.539-1.118l1.07-3.292a1 1 0 00-.364-1.118L2.98 8.72c-.783-.57-.38-1.81.588-1.81h3.461a1 1 0 00.951-.69l1.07-3.292z" />
                        </svg>
                    </button>
                    <div class="card-content-scroll">
                        <p id="card-front-text" class="card-text text-slate-800">Henter kort...</p>
                    </div>
                    <div class="card-footer bg-slate-50 border-t border-slate-100 text-slate-400 text-xs uppercase tracking-widest">
                        <p id="card-front-footer"></p>
                    </div>
                </div>

                <!-- Bagside -->
                <div class="card-face card-back">
                    <button class="star-btn" title="Gem til senere">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-8 w-8 star-icon text-white/30 transition-colors" viewBox="0 0 20 20" fill="currentColor">
                            <path d="M9.049 2.927c.3-.921 1.603-.921 1.902 0l1.07 3.292a1 1 0 00.95.69h3.462c.969 0 1.371 1.24.588 1.81l-2.8 2.034a1 1 0 00-.364 1.118l1.07 3.292c.3.921-.755 1.688-1.54 1.118l-2.8-2.034a1 1 0 00-1.175 0l-2.8 2.034c-.784.57-1.838-.197-1.539-1.118l1.07-3.292a1 1 0 00-.364-1.118L2.98 8.72c-.783-.57-.38-1.81.588-1.81h3.461a1 1 0 00.951-.69l1.07-3.292z" />
                        </svg>
                    </button>
                    <div class="card-content-scroll">
                        <p id="card-back-text" class="card-text"></p>
                    </div>
                    <div class="card-footer" style="background-color: rgba(0,0,0,0.1); border-top: 1px solid rgba(255,255,255,0.1);">
                        <p id="card-back-footer" class="text-white/60 text-xs uppercase tracking-widest"></p>
                    </div>
                </div>
            </div>
        </div>

        <!-- Feedback Knapper -->
        <div id="flashcard-feedback-buttons" class="grid grid-cols-3 gap-4 mb-8">
            <button id="feedback-correct-btn" class="feedback-btn shadow-green-100">
                <span class="text-2xl mr-2">üòé</span> 
                <span class="hidden sm:inline">Rigtigt</span>
            </button>
            <button id="feedback-unsure-btn" class="feedback-btn shadow-yellow-100">
                <span class="text-2xl mr-2">ü§î</span> 
                <span class="hidden sm:inline">Usikker</span>
            </button>
            <button id="feedback-incorrect-btn" class="feedback-btn shadow-red-100">
                <span class="text-2xl mr-2">üò¨</span> 
                <span class="hidden sm:inline">Forkert</span>
            </button>
        </div>
        
        <!-- Navigation Tip -->
        <p class="text-center text-xs font-semibold text-slate-400/80 mt-6 mb-12 bg-white/40 inline-block px-4 py-2 rounded-full mx-auto backdrop-blur-sm">
            Tastatur: [Mellemrum] Vend ¬∑ [1] Rigtigt ¬∑ [2] Usikker ¬∑ [3] Forkert
        </p>
    </div>

    <!-- QUIZ SEKTION -->
    <div id="quiz-section" class="w-full max-w-4xl mx-auto hidden pb-12">
        <div class="glass-panel rounded-3xl p-8 mb-8">
            <div class="flex justify-center space-x-3 mb-6 bg-slate-100/50 p-1.5 rounded-2xl w-fit mx-auto">
                <button id="show-all-questions-mode-btn" class="mode-btn active">Alle sp√∏rgsm√•l</button>
                <button id="show-one-by-one-mode-btn" class="mode-btn">Et ad gangen</button>
            </div>
            <label class="block text-slate-500 text-xs font-bold uppercase tracking-widest mb-4 text-center">V√¶lg Kapitler</label>
            <div class="relative">
                <select id="quiz-chapter-select" multiple class="block w-full rounded-2xl border-0 bg-white/50 shadow-inner p-4 h-56 text-sm focus:ring-2 focus:ring-indigo-500 font-medium"></select>
            </div>
            <p class="text-xs text-center text-slate-400 mt-3 font-medium">Hold Ctrl / Cmd nede for at v√¶lge flere</p>
        </div>

        <div id="all-questions-mode-container">
            <div class="text-center mb-10">
                <button id="start-all-quiz-btn" class="action-btn bg-indigo-600 hover:bg-indigo-700 text-white shadow-xl shadow-indigo-200 py-4 px-10 text-base">üöÄ Start Quiz</button>
            </div>
            <div id="quiz-question-container" class="space-y-6"></div>
            <div class="text-center mt-12 pb-20">
                <button id="submit-quiz-btn" class="action-btn bg-green-600 hover:bg-green-700 text-white shadow-xl shadow-green-200 py-4 px-10 hidden" disabled>‚úÖ Tjek Svar</button>
                <button id="restart-all-quiz-btn" class="action-btn bg-orange-500 hover:bg-orange-600 text-white shadow-xl shadow-orange-200 py-4 px-10 ml-4 hidden">‚Ü∫ Pr√∏v igen</button>
                <div id="quiz-results" class="mt-8 text-3xl font-extrabold text-slate-800 hidden gradient-text"></div>
            </div>
        </div>

        <div id="one-by-one-mode-container" class="hidden">
            <div class="text-center mb-8">
                <p class="text-slate-400 text-xs uppercase font-bold mb-2">Valgte kapitler</p> 
                <p id="active-chapters-display" class="font-bold text-slate-800 mb-6 text-sm bg-white/60 inline-block px-4 py-2 rounded-xl"></p>
                <button id="start-one-by-one-quiz-btn" class="action-btn bg-indigo-600 hover:bg-indigo-700 text-white shadow-lg shadow-indigo-200">üöÄ Start</button>
            </div>
            <div id="single-question-display" class="glass-panel rounded-3xl p-8 sm:p-10 hidden relative min-h-[350px]">
                <p id="single-question-text" class="text-xl sm:text-2xl font-bold text-slate-800 mb-8 leading-snug"></p>
                <div id="single-options-container" class="space-y-4"></div>
                <div id="single-explanation-text" class="explanation mt-8 hidden text-base shadow-sm"></div>
            </div>
            <div class="text-center mt-10 pb-20">
                <p id="single-quiz-progress" class="text-indigo-400 font-bold mb-6 text-xs uppercase tracking-widest"></p>
                <button id="check-single-answer-btn" class="action-btn bg-green-600 hover:bg-green-700 text-white disabled:opacity-50 hidden shadow-lg shadow-green-200" disabled>Tjek svar</button>
                <button id="next-single-question-btn" class="action-btn bg-indigo-600 hover:bg-indigo-700 text-white ml-4 hidden shadow-lg shadow-indigo-200">N√¶ste ‚Üí</button>
                <button id="restart-single-quiz-btn" class="action-btn bg-orange-500 hover:bg-orange-600 text-white ml-4 hidden shadow-lg shadow-orange-200">Start Forfra</button>
                <div id="single-quiz-results" class="mt-6 font-extrabold text-2xl text-slate-800 hidden"></div>
            </div>
        </div>
    </div>

    <!-- HENTER DINE DATA -->
    <script src="js/data.js"></script>

    <!-- JS LOGIK -->
    <script>
    document.addEventListener('DOMContentLoaded', () => {
        if (typeof allFlashcardCategories === 'undefined' || typeof quizQuestions === 'undefined') {
            console.error("FEJL: Data ikke fundet. Tjek at js/data.js eksisterer.");
            document.body.innerHTML = "<h1 style='text-align:center; margin-top:50px; color:red;'>Fejl: Kunne ikke indl√¶se data.js</h1>";
            return;
        }

        console.log("App starter med Modern Design...");

        // DOM Elementer
        const flashcardSection = document.getElementById('flashcard-section');
        const quizSection = document.getElementById('quiz-section');
        const showFlashcardsBtn = document.getElementById('show-flashcards-btn');
        const showQuizBtn = document.getElementById('show-quiz-btn');

        const card = document.getElementById('flashcard');
        const frontTextElement = document.getElementById('card-front-text');
        const backTextElement = document.getElementById('card-back-text');
        const frontFooterElement = document.getElementById('card-front-footer');
        const backFooterElement = document.getElementById('card-back-footer');
        const progressText = document.getElementById('progress-text');
        const progressBarFill = document.getElementById('progress-bar-fill');
        const categorySelect = document.getElementById('category-select');
        const resetDeckBtn = document.getElementById('reset-deck-btn'); 
        const showBackFirstToggle = document.getElementById('show-back-first-toggle');
        const cardContainerWrapper = document.getElementById('card-container-wrapper');
        
        const btnCorrect = document.getElementById('feedback-correct-btn');
        const btnUnsure = document.getElementById('feedback-unsure-btn');
        const btnIncorrect = document.getElementById('feedback-incorrect-btn');
        const feedbackContainer = document.getElementById('flashcard-feedback-buttons');

        // Quiz DOM
        const quizChapterSelect = document.getElementById('quiz-chapter-select');
        const allQuestionsModeContainer = document.getElementById('all-questions-mode-container');
        const oneByOneModeContainer = document.getElementById('one-by-one-mode-container');
        const startAllQuizBtn = document.getElementById('start-all-quiz-btn');
        const quizQuestionContainer = document.getElementById('quiz-question-container');
        const submitQuizBtn = document.getElementById('submit-quiz-btn');
        const restartAllBtn = document.getElementById('restart-all-quiz-btn');
        const quizResults = document.getElementById('quiz-results');
        const showAllQuestionsModeBtn = document.getElementById('show-all-questions-mode-btn');
        const showOneByOneModeBtn = document.getElementById('show-one-by-one-mode-btn');
        const startOneByOneQuizBtn = document.getElementById('start-one-by-one-quiz-btn');
        const singleQuestionDisplay = document.getElementById('single-question-display');
        const singleQuestionText = document.getElementById('single-question-text');
        const singleOptionsContainer = document.getElementById('single-options-container');
        const singleExplanationText = document.getElementById('single-explanation-text');
        const checkSingleAnswerBtn = document.getElementById('check-single-answer-btn');
        const nextSingleQuestionBtn = document.getElementById('next-single-question-btn');
        const restartSingleQuizBtn = document.getElementById('restart-single-quiz-btn');
        const singleQuizProgress = document.getElementById('single-quiz-progress');
        const singleQuizResults = document.getElementById('single-quiz-results');
        const activeChaptersDisplay = document.getElementById('active-chapters-display');

        // Variables
        let studyQueue = []; 
        let originalTotal = 0;
        let isFlipped = false;
        let showBackFirst = false;
        let savedCards = JSON.parse(localStorage.getItem('flashcard_favorites')) || []; 

        // NAVIGATION
        function showSection(section) {
            if (section === 'flashcards') {
                flashcardSection.classList.remove('hidden');
                quizSection.classList.add('hidden');
                showFlashcardsBtn.classList.add('active');
                showQuizBtn.classList.remove('active');
            } else {
                flashcardSection.classList.add('hidden');
                quizSection.classList.remove('hidden');
                showFlashcardsBtn.classList.remove('active');
                showQuizBtn.classList.add('active');
                if(showAllQuestionsModeBtn) showAllQuestionsModeBtn.click();
            }
        }
        showFlashcardsBtn.addEventListener('click', () => showSection('flashcards'));
        showQuizBtn.addEventListener('click', () => showSection('quiz'));

        // FLASHCARD LOGIC
        function populateCategorySelect() {
            categorySelect.innerHTML = '';
            
            const savedOption = document.createElement('option');
            savedOption.value = 'saved_cards';
            savedOption.textContent = `‚≠ê Gemte kort (${savedCards.length})`;
            categorySelect.appendChild(savedOption);

            const allOption = document.createElement('option');
            allOption.value = 'all_shuffled';
            allOption.textContent = 'üîÄ Bland alle kapitler';
            allOption.selected = true; 
            categorySelect.appendChild(allOption);

            Object.keys(allFlashcardCategories).sort((a, b) => a.localeCompare(b, 'da')).forEach(cat => {
                const opt = document.createElement('option');
                opt.value = cat;
                opt.textContent = cat;
                categorySelect.appendChild(opt);
            });
            loadCategory('all_shuffled');
        }

        function loadCategory(categoryName) {
            let tempDeck = [];
            if (categoryName === 'saved_cards') {
                if (savedCards.length === 0) {
                    alert("Ingen gemte kort.");
                    categorySelect.value = 'all_shuffled';
                    loadCategory('all_shuffled');
                    return;
                }
                tempDeck = [...savedCards];
            } else if (categoryName === 'all_shuffled') {
                for (const [catName, cards] of Object.entries(allFlashcardCategories)) {
                    tempDeck = tempDeck.concat(cards.map(c => ({ ...c, sourceCategory: catName })));
                }
                shuffleArray(tempDeck);
            } else {
                if (allFlashcardCategories[categoryName]) {
                    tempDeck = allFlashcardCategories[categoryName].map(c => ({...c, sourceCategory: categoryName}));
                }
                shuffleArray(tempDeck);
            }
            studyQueue = [...tempDeck];
            originalTotal = studyQueue.length;
            isFlipped = false;
            card.classList.remove('is-flipped');
            updateCardUI();
        }

        function updateCardUI() {
            document.querySelectorAll('.star-btn').forEach(btn => {
                btn.onclick = toggleSaveCard;
            });

            if (studyQueue.length === 0) {
                frontTextElement.textContent = originalTotal === 0 ? "Ingen kort valgt." : "üéâ Godt g√•et! Du er igennem bunken.";
                backTextElement.textContent = "Start forfra?";
                feedbackContainer.classList.add('hidden');
                progressText.textContent = "F√¶rdig!";
                progressBarFill.style.width = "100%";
                return;
            }
            feedbackContainer.classList.remove('hidden');
            const cardData = studyQueue[0];
            
            frontTextElement.textContent = showBackFirst ? cardData.back : cardData.front;
            backTextElement.textContent = showBackFirst ? cardData.front : cardData.back;
            const footer = cardData.sourceCategory || "";
            frontFooterElement.textContent = footer;
            backFooterElement.textContent = footer;

            const completed = originalTotal - studyQueue.length;
            const pct = originalTotal > 0 ? (completed / originalTotal) * 100 : 0;
            progressBarFill.style.width = `${pct}%`;
            progressText.textContent = `${studyQueue.length} tilbage`;

            const isSaved = savedCards.some(s => s.front === cardData.front && s.back === cardData.back);
            document.querySelectorAll('.star-btn').forEach(btn => {
                if (isSaved) btn.classList.add('active'); else btn.classList.remove('active');
            });
        }

        function handleFeedback(type) {
            if (studyQueue.length === 0) return;
            const currentCard = studyQueue[0];
            
            // Animation
            cardContainerWrapper.style.opacity = '0';
            cardContainerWrapper.style.transform = 'scale(0.9) translateY(20px)';
            cardContainerWrapper.style.transition = 'all 0.2s';

            setTimeout(() => {
                if (type === 'correct') studyQueue.shift();
                else if (type === 'incorrect') { studyQueue.shift(); studyQueue.push(currentCard); }
                else if (type === 'unsure') { 
                    studyQueue.shift(); 
                    const idx = Math.floor(Math.random() * studyQueue.length);
                    studyQueue.splice(idx, 0, currentCard);
                }
                isFlipped = false;
                card.classList.remove('is-flipped');
                updateCardUI();
                cardContainerWrapper.style.opacity = '1';
                cardContainerWrapper.style.transform = 'scale(1) translateY(0)';
            }, 200);
        }

        function toggleSaveCard(e) {
            e.stopPropagation();
            if (studyQueue.length === 0) return;
            const currentCard = studyQueue[0];
            const idx = savedCards.findIndex(s => s.front === currentCard.front && s.back === currentCard.back);
            if (idx > -1) savedCards.splice(idx, 1);
            else savedCards.push(currentCard);
            localStorage.setItem('flashcard_favorites', JSON.stringify(savedCards));
            
            const savedOpt = categorySelect.querySelector('option[value="saved_cards"]');
            if(savedOpt) savedOpt.textContent = `‚≠ê Gemte kort (${savedCards.length})`;
            updateCardUI();
        }

        function shuffleArray(array) {
            for (let i = array.length - 1; i > 0; i--) {
                const j = Math.floor(Math.random() * (i + 1));
                [array[i], array[j]] = [array[j], array[i]];
            }
        }

        // LISTENERS
        categorySelect.addEventListener('change', (e) => loadCategory(e.target.value));
        resetDeckBtn.addEventListener('click', () => loadCategory(categorySelect.value));
        showBackFirstToggle.addEventListener('change', (e) => {
            showBackFirst = e.target.checked;
            isFlipped = false;
            card.classList.remove('is-flipped');
            updateCardUI();
        });
        card.addEventListener('click', () => {
            if(studyQueue.length > 0) {
                card.classList.toggle('is-flipped');
                isFlipped = !isFlipped;
            }
        });
        btnCorrect.addEventListener('click', () => handleFeedback('correct'));
        btnUnsure.addEventListener('click', () => handleFeedback('unsure'));
        btnIncorrect.addEventListener('click', () => handleFeedback('incorrect'));
        document.addEventListener('keydown', (e) => {
            if (flashcardSection.classList.contains('hidden')) return;
            if (e.code === 'Space') { e.preventDefault(); if(studyQueue.length>0) { card.classList.toggle('is-flipped'); isFlipped=!isFlipped; } }
            else if (e.key === '1') handleFeedback('correct');
            else if (e.key === '2') handleFeedback('unsure');
            else if (e.key === '3') handleFeedback('incorrect');
        });

        // QUIZ LOGIC 
        function populateQuizChapters() {
            const chapters = [...new Set(quizQuestions.map(q => q.chapter))].sort();
            quizChapterSelect.innerHTML = '';
            chapters.forEach(chap => {
                const opt = document.createElement('option');
                opt.value = chap; opt.textContent = chap; opt.selected = true;
                quizChapterSelect.appendChild(opt);
            });
        }
        
        startAllQuizBtn.addEventListener('click', () => {
             const chapters = Array.from(quizChapterSelect.selectedOptions).map(o=>o.value);
             if(!chapters.length) return alert("V√¶lg kapitel");
             currentQuizQuestions = quizQuestions.filter(q=>chapters.includes(q.chapter));
             shuffleArray(currentQuizQuestions);
             renderAllQuiz();
             startAllQuizBtn.parentElement.classList.add('hidden');
             // Hide entire container of chapter select for clean look
             quizChapterSelect.closest('.glass-panel').classList.add('hidden');
        });

        function renderAllQuiz() {
            quizQuestionContainer.innerHTML = '';
            userAnswers = {};
            submitQuizBtn.classList.remove('hidden');
            submitQuizBtn.disabled = true;
            submitQuizBtn.style.opacity = '0.5';

            currentQuizQuestions.forEach((q, i) => {
                const div = document.createElement('div');
                div.className = "glass-panel p-8 rounded-2xl mb-6 bg-white transition-all hover:shadow-md";
                div.innerHTML = `<h3 class="text-xl font-bold mb-6 text-slate-800">${i+1}. ${q.question}</h3>`;
                const optsDiv = document.createElement('div');
                optsDiv.className = "space-y-3";
                q.options.forEach((opt, idx) => {
                    const char = String.fromCharCode(97+idx);
                    const label = document.createElement('label');
                    label.className = "question-option group";
                    label.innerHTML = `
                        <div class="w-6 h-6 rounded-full border-2 border-slate-300 mr-4 flex items-center justify-center group-hover:border-indigo-400 transition-colors">
                            <div class="w-3 h-3 rounded-full bg-indigo-600 hidden check-dot"></div>
                        </div>
                        <input type="radio" name="q${i}" value="${char}" class="hidden">
                        <span class="text-slate-700">${opt}</span>
                    `;
                    label.onclick = () => {
                        div.querySelectorAll('.question-option').forEach(l=>{
                            l.classList.remove('selected');
                            l.querySelector('.check-dot').classList.add('hidden');
                            l.querySelector('.w-6').classList.remove('border-indigo-600');
                        });
                        label.classList.add('selected');
                        label.querySelector('.check-dot').classList.remove('hidden');
                        label.querySelector('.w-6').classList.add('border-indigo-600');
                        userAnswers[i] = char;
                        if(Object.keys(userAnswers).length === currentQuizQuestions.length) {
                             submitQuizBtn.disabled = false; submitQuizBtn.style.opacity = '1'; submitQuizBtn.style.cursor='pointer';
                        }
                    };
                    optsDiv.appendChild(label);
                });
                div.appendChild(optsDiv);
                const exp = document.createElement('div');
                exp.id = `exp-${i}`; exp.className = "explanation hidden";
                div.appendChild(exp);
                quizQuestionContainer.appendChild(div);
            });
        }

        submitQuizBtn.addEventListener('click', () => {
            let score = 0;
            currentQuizQuestions.forEach((q, i) => {
                const ans = userAnswers[i];
                const correct = ans === q.correctAnswer;
                if(correct) score++;
                const exp = document.getElementById(`exp-${i}`);
                exp.classList.remove('hidden');
                exp.classList.add(correct?'correct':'incorrect');
                exp.innerHTML = (correct?'<strong class="block mb-1">‚úÖ Korrekt!</strong>':'<strong class="block mb-1">‚ùå Forkert.</strong>') + q.feedback;
                
                // Highlight
                const inputs = document.getElementsByName(`q${i}`);
                inputs.forEach(inp => {
                    inp.disabled = true;
                    if(inp.value === q.correctAnswer) inp.parentElement.classList.add('correct-answer');
                    else if(inp.value === ans && !correct) inp.parentElement.classList.add('incorrect-answer');
                });
            });
            quizResults.textContent = `Du fik ${score} ud af ${currentQuizQuestions.length} rigtige`;
            quizResults.classList.remove('hidden');
            submitQuizBtn.classList.add('hidden');
            restartAllBtn.classList.remove('hidden');
            quizResults.scrollIntoView({behavior: 'smooth'});
        });
        
        restartAllBtn.onclick = () => location.reload();

        // One-by-One logic setup
        showOneByOneModeBtn.onclick = () => {
             allQuestionsModeContainer.classList.add('hidden');
             oneByOneModeContainer.classList.remove('hidden');
             showOneByOneModeBtn.classList.add('active');
             showAllQuestionsModeBtn.classList.remove('active');
        };
        showAllQuestionsModeBtn.onclick = () => {
             allQuestionsModeContainer.classList.remove('hidden');
             oneByOneModeContainer.classList.add('hidden');
             showAllQuestionsModeBtn.classList.add('active');
             showOneByOneModeBtn.classList.remove('active');
        };

        let singleQIndex = 0; 
        let singleQData = [];
        startOneByOneQuizBtn.onclick = () => {
             const chapters = Array.from(quizChapterSelect.selectedOptions).map(o=>o.value);
             if(!chapters.length) return alert("V√¶lg kapitel");
             singleQData = quizQuestions.filter(q=>chapters.includes(q.chapter));
             shuffleArray(singleQData);
             singleQIndex = 0;
             startOneByOneQuizBtn.parentElement.classList.add('hidden');
             singleQuestionDisplay.classList.remove('hidden');
             renderSingleQ();
        };

        function renderSingleQ() {
             const q = singleQData[singleQIndex];
             singleQuestionText.textContent = q.question;
             singleOptionsContainer.innerHTML = '';
             singleExplanationText.classList.add('hidden');
             checkSingleAnswerBtn.classList.remove('hidden');
             checkSingleAnswerBtn.disabled = true;
             checkSingleAnswerBtn.style.opacity = '0.5';
             nextSingleQuestionBtn.classList.add('hidden');
             restartSingleQuizBtn.classList.add('hidden');
             singleQuizResults.classList.add('hidden');
             singleQuizProgress.textContent = `SP√òRGSM√ÖL ${singleQIndex+1} AF ${singleQData.length}`;
             
             q.options.forEach((opt, i) => {
                 const char = String.fromCharCode(97+i);
                 const label = document.createElement('label');
                 label.className = "question-option group";
                 label.innerHTML = `
                    <div class="w-6 h-6 rounded-full border-2 border-slate-300 mr-4 flex items-center justify-center group-hover:border-indigo-400 transition-colors">
                            <div class="w-3 h-3 rounded-full bg-indigo-600 hidden check-dot"></div>
                    </div>
                    <input type="radio" name="singleQ" value="${char}" class="hidden">
                    <span>${opt}</span>
                 `;
                 label.onclick = () => {
                     if(!checkSingleAnswerBtn.disabled && checkSingleAnswerBtn.classList.contains('hidden')) return;
                     singleOptionsContainer.querySelectorAll('.question-option').forEach(l=>{
                         l.classList.remove('selected');
                         l.querySelector('.check-dot').classList.add('hidden');
                     });
                     label.classList.add('selected');
                     label.querySelector('.check-dot').classList.remove('hidden');
                     label.querySelector('input').checked = true;
                     checkSingleAnswerBtn.disabled = false;
                     checkSingleAnswerBtn.style.opacity = '1';
                 };
                 singleOptionsContainer.appendChild(label);
             });
        }
        
        checkSingleAnswerBtn.onclick = () => {
             const q = singleQData[singleQIndex];
             const sel = document.querySelector('input[name="singleQ"]:checked');
             const val = sel.value;
             const correct = val === q.correctAnswer;
             
             singleExplanationText.classList.remove('hidden');
             singleExplanationText.classList.remove('correct','incorrect');
             singleExplanationText.classList.add(correct?'correct':'incorrect');
             singleExplanationText.innerHTML = (correct?'<strong class="block mb-2">‚úÖ Korrekt!</strong>':'<strong class="block mb-2">‚ùå Forkert.</strong>') + q.feedback;
             
             // Lock
             document.querySelectorAll('input[name="singleQ"]').forEach(i=>i.disabled=true);
             
             // Color
             singleOptionsContainer.querySelectorAll('label').forEach((lbl, idx) => {
                 const char = String.fromCharCode(97+idx);
                 if(char === q.correctAnswer) lbl.classList.add('correct-answer');
                 else if(char === val && !correct) lbl.classList.add('incorrect-answer');
             });

             checkSingleAnswerBtn.classList.add('hidden');
             if(singleQIndex < singleQData.length -1) nextSingleQuestionBtn.classList.remove('hidden');
             else { restartSingleQuizBtn.classList.remove('hidden'); singleQuizResults.textContent="Godt klaret! Du er f√¶rdig."; singleQuizResults.classList.remove('hidden'); }
        };
        nextSingleQuestionBtn.onclick = () => { singleQIndex++; renderSingleQ(); };
        restartSingleQuizBtn.onclick = () => location.reload();

        // INIT
        populateCategorySelect();
        populateQuizChapters();
    });
    </script>
</body>
</html>
